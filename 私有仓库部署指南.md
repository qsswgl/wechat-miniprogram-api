# 私有Docker仓库部署指南

## 🐳 .NET 8独立部署到私有仓库 43.138.35.183

### 📋 项目配置

已配置为.NET 8独立部署模式：
- ✅ **SelfContained**: true (包含所有运行时依赖)
- ✅ **PublishTrimmed**: true (减小镜像大小)
- ✅ **PublishSingleFile**: true (单文件部署)
- ✅ **RuntimeIdentifier**: linux-x64

### 🔧 Docker配置

#### 1. 配置私有仓库

如果私有仓库使用HTTP (非HTTPS)，需要配置Docker允许不安全连接：

**Windows (Docker Desktop)**:
1. 打开Docker Desktop设置
2. 进入 "Docker Engine" 配置
3. 添加以下配置：
```json
{
  "insecure-registries": ["43.138.35.183:5000"]
}
```

**Linux**:
编辑 `/etc/docker/daemon.json`:
```json
{
  "insecure-registries": ["43.138.35.183:5000"]
}
```

重启Docker服务：
```bash
sudo systemctl restart docker
```

#### 2. 构建和推送命令

```cmd
# 自动化构建推送
build-and-push-private.bat

# 手动构建推送
docker build -f Dockerfile.net8 -t 43.138.35.183:5000/wechat-api-net8:latest .
docker push 43.138.35.183:5000/wechat-api-net8:latest
```

### 🚀 部署到目标服务器

#### 在目标服务器上运行

```bash
# 拉取镜像
docker pull 43.138.35.183:5000/wechat-api-net8:latest

# 运行容器
docker run -d \
  --name wechat-api \
  -p 8080:8080 \
  -v $(pwd)/uploadall:/app/wwwroot/uploadall \
  --restart unless-stopped \
  43.138.35.183:5000/wechat-api-net8:latest

# 检查状态
docker ps
docker logs wechat-api
```

#### 访问应用

- **API文档**: http://服务器IP:8080/swagger
- **健康检查**: http://服务器IP:8080/health
- **API接口**: http://服务器IP:8080/api/wechat/

### 📊 独立部署优势

1. **无需安装.NET运行时**: 镜像包含所有依赖
2. **更小的基础镜像**: 使用Ubuntu而非.NET运行时镜像
3. **更快的启动**: 独立可执行文件
4. **更好的安全性**: 非root用户运行
5. **跨平台兼容**: linux-x64运行时

### 🔍 故障排除

#### 推送失败

```bash
# 检查网络连接
ping 43.138.35.183

# 检查端口连通性
telnet 43.138.35.183 5000

# 如需认证
docker login 43.138.35.183:5000
```

#### 容器启动失败

```bash
# 查看详细日志
docker logs --details wechat-api

# 进入容器调试
docker run -it --rm 43.138.35.183:5000/wechat-api-net8:latest /bin/bash

# 检查文件权限
docker run -it --rm 43.138.35.183:5000/wechat-api-net8:latest ls -la
```

### 📝 镜像信息

- **基础镜像**: Ubuntu 22.04
- **应用类型**: .NET 8 独立部署
- **运行用户**: appuser (非root)
- **暴露端口**: 8080 (HTTP)
- **工作目录**: /app
- **可执行文件**: ./WeChatMiniProgramAPI

### 🔄 更新部署

```bash
# 停止现有容器
docker stop wechat-api
docker rm wechat-api

# 拉取最新镜像
docker pull 43.138.35.183:5000/wechat-api-net8:latest

# 重新启动
docker run -d --name wechat-api -p 8080:8080 43.138.35.183:5000/wechat-api-net8:latest
```

---

使用 `build-and-push-private.bat` 一键构建并推送到私有仓库！
